<html>

<head>
    <meta charset="utf-8">
    <title>Audio With Camera Example — naf-janus-adapter</title>
    <meta name="description" content="Audio With Camera Example — naf-janus-adapter">

    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
    <script src="https://unpkg.com/networked-aframe@^0.11.0/dist/networked-aframe.min.js"></script>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js" crossorigin="anonymous"></script>
    <script src="/dist/naf-janus-adapter.js"></script>
</head>

<body>
    <a-scene networked-scene="
        room: 1;
        debug: true;
        adapter: janus;
        connectOnLoad: true;
        serverURL: wss://cowebxr.com:8989/janus;
      ">
        <a-assets>

            <img id="grid" src="assets/grid.png" />
            <img id="sky" src="assets/sky.jpg" />

            <img id="groundTexture" src="https://cdn.aframe.io/a-painter/images/floor.jpg">

            <!-- Templates -->

            <!-- Avatar -->
            <template id="avatar-template" type="text/html">
                <a-entity class="avatar" networked-audio-source>
                    <a-plane color="#fff" width="4" height="3" position="0 .6 0" material="side: back"
                        networked-video-source></a-plane>
                    <a-sphere class="head" color="#5985ff" scale="0.45 0.5 0.4"></a-sphere>
                    <a-entity class="face" position="0 0.05 0">
                        <a-sphere class="eye" color="#efefef" position="0.16 0.1 -0.35" scale="0.12 0.12 0.12">
                            <a-sphere class="pupil" color="#000" position="0 0 -1" scale="0.2 0.2 0.2"></a-sphere>
                        </a-sphere>
                        <a-sphere class="eye" color="#efefef" position="-0.16 0.1 -0.35" scale="0.12 0.12 0.12">
                            <a-sphere class="pupil" color="#000" position="0 0 -1" scale="0.2 0.2 0.2"></a-sphere>
                        </a-sphere>
                    </a-entity>
                </a-entity>
            </template>

            <!-- /Templates -->
        </a-assets>

        <a-entity id="player" networked="template:#avatar-template;attachTemplateToLocal:false;" camera
            position="0 1.6 0" wasd-controls look-controls>
            <a-entity class="head" random-color></a-entity>
        </a-entity>

        <a-entity position="0 0 0" geometry="primitive: plane; width: 10000; height: 10000;" rotation="-90 0 0"
            material="src: #grid; repeat: 10000 10000; transparent: true; metalness:0.6; roughness: 0.4; sphericalEnvMap: #sky;"></a-entity>

        <!-- <a-entity environment="preset: default; groundColor: #445; grid: cross"></a-entity>
        <a-plane static-body src="#groundTexture" rotation="-90 0 0" position="0 -0.1 0" width="100" height="100"></a-plane> -->

        <a-entity light="color: #ccccff; intensity: 1; type: ambient;" visible=""></a-entity>
        <a-entity light="color: #ffaaff; intensity: 1.5" position="5 5 5"></a-entity>

        <!-- <a-sky src="#sky" rotation="0 -90 0"></a-sky> -->
        <!-- <a-entity id="particles" particle-system="preset: snow"></a-entity> -->
    </a-scene>

    <script>
        function genClientId() {
            let num = '';
            for (let i = 0; i < 16; i++) {
                num += Math.floor(Math.random() * 10).toString();
            }
            return num;
        }

        // On mobile remove elements that are resource heavy
        var isMobile = AFRAME.utils.device.isMobile();
        if (isMobile) {
            var particles = document.getElementById('particles');
            particles.parentNode.removeChild(particles);
        }

        // Prompt for audio.
        document.addEventListener('DOMContentLoaded', () => {
            const scene = document.querySelector('a-scene');
            scene.addEventListener('adapter-ready', ({ detail: adapter }) => {
                const clientId = genClientId(); // generate a random 16 characters string, but you can use a uuid4 for example
                adapter.setClientId(clientId);
                navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                    adapter.setLocalMediaStream(stream).then(() => {
                        // Note that networked-scene audio:true option has no effect with the janus adapter
                        adapter.enableMicrophone(true); // set it to false if you want to be muted initially.
                        const currentStream = stream;
                        navigator.mediaDevices.getUserMedia(
                            {
                                video: {
                                    mediaSource: "camera",
                                    width: { max: 1280, ideal: 640 },
                                    height: { ideal: 360 },
                                    frameRate: 30
                                }
                            }).then((stream) => {
                                currentStream.addTrack(stream.getVideoTracks()[0]);
                                adapter.setLocalMediaStream(currentStream);
                            });
                    });
                }).catch(err => {
                    console.warn("Microphone access not allowed. This client will not broadcast audio.");
                });
            });
        });
    </script>

    <script>
        // Define custom schema for syncing avatar color, set by random-color
        NAF.schemas.add({
            template: '#avatar-template',
            components: [
                'position',
                'rotation',
                {
                    selector: '.head',
                    component: 'material',
                    property: 'color'
                }
            ]
        });
        // Called by Networked-Aframe when connected to server
        function onConnect() {
            console.log("onConnect", new Date());
        }
    </script>
</body>

</html>